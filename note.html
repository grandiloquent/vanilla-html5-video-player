<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>笔记</title>

    <style>
        html,
        body {
            margin: 0;
            height: 100%;
            font-family: Roboto
        }

        textarea {
            outline: 0;
            border: 0;
            resize: none;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
            flex: 1 1 0;
            font-size: 18px;
            font-family: Roboto, Consolas;
            min-height: 300px
        }
    </style>
</head>

<body>

    <div style="display: flex;flex-direction: column;height: 100%;">
        <custom-toolbar editor="textarea"></custom-toolbar>
        <textarea></textarea>
    </div>
    <script>
        function appendAnchor(container, editor) {
            console.log("appendAnchor, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = "M17.016 11.016q1.641 0 2.813 1.172t1.172 2.813-1.172 2.813-2.813 1.172h-2.016v2.016l-3-3 3-3v2.016h2.25q0.797 0 1.406-0.609t0.609-1.406-0.609-1.406-1.406-0.609h-13.266v-1.969h13.031zM20.016 5.016v1.969h-16.031v-1.969h16.031zM3.984 18.984v-1.969h6v1.969h-6z";
            const element = makeItem(d, event => {
                processSelection(editor, (selection) => {
                    const pieces = selection.split(/[：:]/g);
                    const start = pieces[0].trim();
                    const end = pieces.length > 1 ? pieces[1].trim() : '';
                    return `* ::**${start}**：${end}::{#${start.toLowerCase()}}`;
                });
            }, "自定义锚点区块");
            container.appendChild(element);
        }

        function appendCode(container, editor) {
            console.log("appendCode, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = 'M18.984 20.016v-16.031h-1.969v3h-10.031v-3h-1.969v16.031h13.969zM12 2.016q-0.422 0-0.703 0.281t-0.281 0.703 0.281 0.703 0.703 0.281 0.703-0.281 0.281-0.703-0.281-0.703-0.703-0.281zM18.984 2.016q0.797 0 1.406 0.586t0.609 1.383v16.031q0 0.797-0.609 1.383t-1.406 0.586h-13.969q-0.797 0-1.406-0.586t-0.609-1.383v-16.031q0-0.797 0.609-1.383t1.406-0.586h4.172q0.328-0.891 1.078-1.453t1.734-0.563 1.734 0.563 1.078 1.453h4.172z'
            const element = makeItem(d, event => {
                processSelection(editor, (selection) => {
                    return '`' + selection + '`';
                });
            }, "代码");
            container.appendChild(element);
        }

        function appendCopy(container, editor) {
            console.log("appendCopy, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = 'M19.5 9.516q1.031 0 1.758 0.727t0.727 1.758-0.727 1.758-1.758 0.727q-1.688 0-2.297-1.5h-2.906q-0.609 1.5-2.297 1.5t-2.297-1.5h-2.906q-0.609 1.5-2.297 1.5-1.031 0-1.758-0.727t-0.727-1.758 0.727-1.758 1.758-0.727q1.688 0 2.297 1.5h2.906q0.609-1.5 2.297-1.5t2.297 1.5h2.906q0.609-1.5 2.297-1.5z'
            const element = makeItem(d, event => {
                copyLine(editor);
            }, "复制");
            container.appendChild(element);
        }

        function appendDecreaseIndent(container, editor) {
            console.log("appendDecreaseIndent, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = "M11.016 12.984v-1.969h9.984v1.969h-9.984zM11.016 9v-2.016h9.984v2.016h-9.984zM3 3h18v2.016h-18v-2.016zM3 21v-2.016h18v2.016h-18zM3 12l3.984-3.984v7.969zM11.016 17.016v-2.016h9.984v2.016h-9.984z";
            const element = makeItem(d, event => {
                indent(editor, 0);
            }, "复制");
            container.appendChild(element);
        }

        function appendformat(container, editor) {
            console.log("appendformat, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = 'M14.016 17.016l1.969-4.031h-3v-6h6v6l-1.969 4.031h-3zM6 17.016l2.016-4.031h-3v-6h6v6l-2.016 4.031h-3z';
            const element = makeItem(d, event => {
                formatCurrent(editor);
            }, "格式化");
            container.appendChild(element);
        }

        function appendBold(container, editor) {
            console.log("appendBold, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = "M13.5 15.516q0.656 0 1.078-0.445t0.422-1.055-0.422-1.055-1.078-0.445h-3.516v3h3.516zM9.984 6.516v3h3q0.609 0 1.055-0.445t0.445-1.055-0.445-1.055-1.055-0.445h-3zM15.609 10.781q2.156 0.984 2.156 3.422 0 1.594-1.055 2.695t-2.648 1.102h-7.078v-14.016h6.281q1.688 0 2.836 1.172t1.148 2.859-1.641 2.766z"
            const element = makeItem(d, event => {
                let start = editor.selectionStart;
                let end = editor.selectionEnd;

                if (start !== end) {
                    processSelection(editor, (selection) => {
                        const prefix = start - 1 > -1 && editor.value[start - 1] !== ' ' && editor.value[start - 1] !== '\n' ?
                            ' ' : '';

                        return prefix + '**' + selection + '** ';

                    });
                } else {
                    console.log(start, end);
                    const string = editor.value;
                    while (start > 0 && string[start - 1] !== '\n') {
                        start--;
                    }
                    while (end < string.length) {
                        end++;
                        if (string[end] === '\n') break;

                    }
                    //console.log('xxx' + string.substring(start, end).replace('\n', 'g') + "xxx");

                    editor.setRangeText(`**${string.substring(start, end)}**`, start, end);
                }

            }, "粗体");
            container.appendChild(element);
        }
        async function google(value) {
            const to = new URL(window.location.href).searchParams.get('to');
            const response = await fetch(`https://service-mayeka3y-1258705152.hk.apigw.tencentcs.com/release/translate?q=${value.trim()}&to=zh`);
            const obj = await response.text();
            const lines = [];
            const translated = JSON.parse(obj.replaceAll(/您/g, '你').replaceAll(/ - /g, "——"));
            if (translated.sentences) {
                const sentences = translated.sentences;
                for (let index = 0; index < sentences.length; index++) {
                    const element = sentences[index];
                    lines.push(element.orig);
                    lines.push(element.trans);
                }
            } else {
                const trans = translated.trans_result;
                for (let index = 0; index < trans.length; index++) {
                    const element = trans[index];
                    lines.push(element.src);
                    lines.push(element.dst);
                }
            }
            return lines;
        }


        async function trans(editor) {
            let start = editor.selectionStart;
            let end = editor.selectionEnd;

            const string = editor.value;
            while (start > 0 && string[start - 1] !== '\n') {
                start--;
            }
            while (end < string.length) {
                end++;
                if (string[end] === '\n') break;

            }
            const value = string.substring(start, end);
            if (!value.trim()) return;
            const lines = await google(value);

            editor.setRangeText(`${lines.join('\n')}`, start, end);

        }

        function appendTrans(container, editor) {
            const d = 'M20.484 18l-3 3v-2.016h-12.469v-1.969h12.469v-2.016zM10.125 9.984h3.75l-1.875-5.016zM12.75 3l4.734 11.016h-2.063l-0.938-2.203h-4.969l-0.938 2.203h-2.063l4.734-11.016h1.5z'
            const element = makeItem(d, async event => {
                await trans(editor);

            }, "粗体");
            container.appendChild(element);
        }

        function appendHeader2(container, editor) {
            console.log("appendHeader2, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = ''
            const element = makeItem(d, event => {
                formatHead(editor, 2);
            }, "标题");
            container.appendChild(element);
        }

        function appendHeader3(container, editor) {
            console.log("appendHeader3, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = ''
            const element = makeItem(d, event => {
                formatHead(editor, 3);
            }, "标题");
            container.appendChild(element);
        }

        function appendCut(container, editor) {
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = "M18.984 3h3v0.984l-6.984 7.031-2.016-2.016zM12 12.516q0.516 0 0.516-0.516t-0.516-0.516-0.516 0.516 0.516 0.516zM6 20.016q0.797 0 1.406-0.586t0.609-1.43-0.609-1.43-1.406-0.586-1.406 0.586-0.609 1.43 0.609 1.43 1.406 0.586zM6 8.016q0.797 0 1.406-0.586t0.609-1.43-0.609-1.43-1.406-0.586-1.406 0.586-0.609 1.43 0.609 1.43 1.406 0.586zM9.656 7.641l12.328 12.375v0.984h-3l-6.984-6.984-2.344 2.344q0.328 0.703 0.328 1.641 0 1.641-1.172 2.813t-2.813 1.172-2.813-1.172-1.172-2.813 1.172-2.813 2.813-1.172q0.938 0 1.641 0.328l2.344-2.344-2.344-2.344q-0.703 0.328-1.641 0.328-1.641 0-2.813-1.172t-1.172-2.813 1.172-2.813 2.813-1.172 2.813 1.172 1.172 2.813q0 0.938-0.328 1.641z"
            const element = makeItem(d, event => {
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                const string = editor.value.substring(start, end);
                window.localStorage.setItem('string', string);
                editor.setRangeText('', start, end);
            }, "剪切");
            container.appendChild(element);
        }

        function appendIncreaseIndent(container, editor) {
            console.log("appendIncreaseIndent, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = "M11.016 12.984v-1.969h9.984v1.969h-9.984zM11.016 9v-2.016h9.984v2.016h-9.984zM3 3h18v2.016h-18v-2.016zM11.016 17.016v-2.016h9.984v2.016h-9.984zM3 8.016l3.984 3.984-3.984 3.984v-7.969zM3 21v-2.016h18v2.016h-18z"
            const element = makeItem(d, event => {
                indent(editor, 1);
            }, "缩进");
            container.appendChild(element);
        }

        function appendItalic(container, editor) {
            console.log("appendItalic, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = "M9.984 3.984h8.016v3h-2.813l-3.375 8.016h2.203v3h-8.016v-3h2.813l3.375-8.016h-2.203v-3z";
            const element = makeItem(d, event => {
                processSelection(editor, (selection) => {
                    return '_' + selection.replace(/^_|[，,_]+$/g, '') + '_';
                });
            }, "斜体");
            container.appendChild(element);
        }

        function appendLink(container, editor) {
            console.log("appendLink, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = "M17.016 6.984q2.063 0 3.516 1.477t1.453 3.539-1.453 3.539-3.516 1.477h-4.031v-1.922h4.031q1.266 0 2.18-0.914t0.914-2.18-0.914-2.18-2.18-0.914h-4.031v-1.922h4.031zM8.016 12.984v-1.969h7.969v1.969h-7.969zM3.891 12q0 1.266 0.914 2.18t2.18 0.914h4.031v1.922h-4.031q-2.063 0-3.516-1.477t-1.453-3.539 1.453-3.539 3.516-1.477h4.031v1.922h-4.031q-1.266 0-2.18 0.914t-0.914 2.18z"
            const element = makeItem(d, event => {
                processSelection(editor, (selection) => {
                    return `[${selection.trim()}](#${selection.trim().toLowerCase()})`
                });
            }, "插入超链接");
            container.appendChild(element);
        }

        function appendList(container, editor) {
            console.log("appendList, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = 'M6.984 5.016h14.016v1.969h-14.016v-1.969zM6.984 12.984v-1.969h14.016v1.969h-14.016zM6.984 18.984v-1.969h14.016v1.969h-14.016zM3.984 16.5q0.609 0 1.055 0.445t0.445 1.055-0.445 1.055-1.055 0.445-1.055-0.445-0.445-1.055 0.445-1.055 1.055-0.445zM3.984 4.5q0.609 0 1.055 0.422t0.445 1.078-0.445 1.078-1.055 0.422-1.055-0.422-0.445-1.078 0.445-1.078 1.055-0.422zM3.984 10.5q0.609 0 1.055 0.422t0.445 1.078-0.445 1.078-1.055 0.422-1.055-0.422-0.445-1.078 0.445-1.078 1.055-0.422z';
            const element = makeItem(d, event => {
                const p = findExtendPosition(editor);
                editor.setRangeText(
                    editor.value.substring(p[0], p[1])
                        .split('\n')
                        .map(i => {
                            // console.log(i);
                            // if (i.startsWith('*')) {
                            //     return i.substring(2);
                            // } else {}
                            return '* ' + i;

                        })
                        .join('\n'), p[0], p[1]);
            }, "列表");
            container.appendChild(element);
        }

        function appendPaste(container, editor) {
            console.log("appendPaste, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = 'M18.984 20.016v-16.031h-1.969v3h-10.031v-3h-1.969v16.031h13.969zM12 2.016q-0.422 0-0.703 0.281t-0.281 0.703 0.281 0.703 0.703 0.281 0.703-0.281 0.281-0.703-0.281-0.703-0.703-0.281zM18.984 2.016q0.797 0 1.406 0.586t0.609 1.383v16.031q0 0.797-0.609 1.383t-1.406 0.586h-13.969q-0.797 0-1.406-0.586t-0.609-1.383v-16.031q0-0.797 0.609-1.383t1.406-0.586h4.172q0.328-0.891 1.078-1.453t1.734-0.563 1.734 0.563 1.078 1.453h4.172z'
            const element = makeItem(d, event => {
                pasteSelectionText(editor);
                // navigator.clipboard.readText().then(val => {

                //     editor.value = editor.value.trim() + "\n\n" + val.trim();
                // })
            }, "粘贴");
            container.appendChild(element);
        }

        function appendRemove1(container, editor) {
            console.log("appendRemove1, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = "M18.984 6.422l-5.578 5.578 5.578 5.578-1.406 1.406-5.578-5.578-5.578 5.578-1.406-1.406 5.578-5.578-5.578-5.578 1.406-1.406 5.578 5.578 5.578-5.578z";
            const element = makeItem(d, event => {
                const p = findWhitespaceLine(editor);
                editor.setRangeText('\n', p[0], p[1]);
            }, "删除");
            container.appendChild(element);
        }

        function appendRemove2(container, editor) {
            console.log("appendRemove2, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = "M12 20.016q3.281 0 5.648-2.367t2.367-5.648-2.367-5.648-5.648-2.367-5.648 2.367-2.367 5.648 2.367 5.648 5.648 2.367zM12 2.016q4.125 0 7.055 2.93t2.93 7.055-2.93 7.055-7.055 2.93-7.055-2.93-2.93-7.055 2.93-7.055 7.055-2.93zM14.578 8.016l1.406 1.406-2.578 2.578 2.578 2.578-1.406 1.406-2.578-2.578-2.578 2.578-1.406-1.406 2.578-2.578-2.578-2.578 1.406-1.406 2.578 2.578z"
            const element = makeItem(d, event => {
                const p = findWhitespaceLine(editor);
                editor.setRangeText('', p[0], p[1] + 1);
            }, "删除");
            container.appendChild(element);
        }

        function appendSort(container, editor) {
            console.log("appendSort, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = "M15.75 16.125h6.094v1.594h-8.531v-1.266l5.906-8.578h-5.859v-1.594h8.297v1.266zM4.969 13.641h3.891l-1.969-5.203zM6.094 6.281h1.641l4.5 11.438h-1.828l-0.938-2.438h-5.109l-0.938 2.438h-1.828zM10.266 19.359h4.641l-2.344 2.344zM14.953 4.641h-4.734l2.344-2.344z";
            const element = makeItem(d, event => {
                processSelection(editor, (selection) => {
                    const string = selection.split('\n');
                    const array = [];
                    for (let index = 0; index < string.length; index++) {
                        const element = string[index];
                        array.push(element.trim());
                    }
                    return array.sort().join('\n');
                })
            }, "排序");
            container.appendChild(element);
        }

        function appendSplit(container, editor) {
            console.log("appendSplit, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = 'M3 5.016h18v1.969h-18v-1.969zM3 11.016v-2.016h18v2.016h-18zM3 18.984v-6h18v6h-18z'
            const element = makeItem(d, event => {
                const p = findExtendPosition(editor);
                editor.setRangeText(
                    editor.value.substring(p[0], p[1])
                        .split(/\.|\* /g)
                        .map(i => i.trim() + '.')
                        .filter(i => i && i !== ".")
                        .join('\n\n'), p[0], p[1]);
            }, "分割");
            container.appendChild(element);
        }

        function appendSub(container, editor) {
            console.log("appendSub, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = 'M18.984 20.016v-16.031h-1.969v3h-10.031v-3h-1.969v16.031h13.969zM12 2.016q-0.422 0-0.703 0.281t-0.281 0.703 0.281 0.703 0.703 0.281 0.703-0.281 0.281-0.703-0.281-0.703-0.703-0.281zM18.984 2.016q0.797 0 1.406 0.586t0.609 1.383v16.031q0 0.797-0.609 1.383t-1.406 0.586h-13.969q-0.797 0-1.406-0.586t-0.609-1.383v-16.031q0-0.797 0.609-1.383t1.406-0.586h4.172q0.328-0.891 1.078-1.453t1.734-0.563 1.734 0.563 1.078 1.453h4.172z'
            const element = makeItem(d, event => {
                processSelection(editor, (selection) => {
                    return '~' + selection + '~';
                });
            }, "下标");
            container.appendChild(element);
        }

        function appendSup(container, editor) {
            console.log("appendSup, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = 'M18.984 20.016v-16.031h-1.969v3h-10.031v-3h-1.969v16.031h13.969zM12 2.016q-0.422 0-0.703 0.281t-0.281 0.703 0.281 0.703 0.703 0.281 0.703-0.281 0.281-0.703-0.281-0.703-0.703-0.281zM18.984 2.016q0.797 0 1.406 0.586t0.609 1.383v16.031q0 0.797-0.609 1.383t-1.406 0.586h-13.969q-0.797 0-1.406-0.586t-0.609-1.383v-16.031q0-0.797 0.609-1.383t1.406-0.586h4.172q0.328-0.891 1.078-1.453t1.734-0.563 1.734 0.563 1.078 1.453h4.172z'
            const element = makeItem(d, event => {
                processSelection(editor, (selection) => {
                    return '^' + selection + '^';
                });
            }, "上标");
            container.appendChild(element);
        }

        function appendTranslate(container, editor) {
            console.log("appendTranslate, ");
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = "M15.891 17.016h3.234l-1.641-4.359zM18.516 9.984l4.5 12h-2.016l-1.125-3h-4.734l-1.125 3h-2.016l4.5-12h2.016zM12.891 15.047l-0.797 2.063-3.094-3.094-5.016 4.969-1.406-1.406 5.109-5.016q-1.875-2.063-3-4.547h2.016q0.984 1.875 2.297 3.328 2.156-2.391 3.188-5.344h-11.203v-2.016h7.031v-1.969h1.969v1.969h7.031v2.016h-2.953q-0.469 1.5-1.547 3.398t-2.156 3.117l-0.047 0.047z";
            const element = makeItem(d, async event => {
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                if (end - start <= 0) return;
                const string = editor.value.substring(start, end);
                const result = await translate(string);
                const obj = JSON.parse(result);
                appendModal(obj);
            }, "单词翻译");
            container.appendChild(element);
        }

        function appendVerticalSplit(container, editor) {
            if (!editor) throw new Error(`The 'editor' cant be null!`);
            const d = "M12.984 5.016h8.016v13.969h-8.016v-13.969zM3 5.016h8.016v1.969h-8.016v-1.969zM3 11.016v-2.016h8.016v2.016h-8.016zM3 18.984v-1.969h8.016v1.969h-8.016zM3 15v-2.016h8.016v2.016h-8.016z"
            const element = makeItem(d, event => {
                const string = editor.value;
                let found = -1;
                for (let index = 0; index < string.length; index++) {
                    const element = string[index];
                    if (element === '\n' && index >= 1000) {
                        found = index;
                        break;
                    }
                }
                if (found === -1) {
                    writeText(string);
                    editor.value = '';
                    return;
                }
                writeText(string.substring(0, found + 1));
                editor.value = string.substring(found + 1);
            }, "分割");
            container.appendChild(element);
        }

        function copyLine(editor) {

            /*
            let start = editor.selectionStart;
            let end = editor.selectionEnd;
            const string = editor.value;
            if ((string.charAt(start) === '\n' && string.charAt(start) === '。') && start - 1 > -1) {
                start--;
            }
            while (start > 0 && (string.charAt(start) !== '\n' && string.charAt(start) !== '。')) {
                start--;
            }
            while (end < string.length && (string.charAt(end) !== '\n' && string.charAt(end) !== '。')) {
                end++;
            }
            if (start !== 0) start++;
            if (end < string.length) end++;
            const value = string.substring(start, end);
            // editor.focus();
            // editor.setSelectionRange(start, end);
            navigator.clipboard.writeText(value);
            
            let start = editor.selectionStart;
            const string = editor.value;
            const value = string.substring(0, start);
            writeText(value);
            editor.setRangeText('', 0, start);
            */
            let start = editor.selectionStart;
            let end = editor.selectionEnd;

            const string = editor.value;
            while (start > 0 && string[start - 1] !== '\n') {
                start--;
            }
            while (end < string.length) {
                end++;
                if (string[end] === '\n') break;

            }
            const value = string.substring(start, end);
            editor.setRangeText('', start, end);
        }

        function findExtendPosition(editor) {
            console.log("findExtendPosition, ");
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            let string = editor.value;
            let offsetStart = start;
            while (offsetStart > 0) {
                if (!/\s/.test(string[offsetStart - 1]))
                    offsetStart--;
                else {
                    let os = offsetStart;
                    while (os > 0 && /\s/.test(string[os - 1])) {
                        os--;
                    }
                    if ([...string.substring(offsetStart, os).matchAll(/\n/g)].length > 1) {
                        break;
                    }
                    offsetStart = os;
                }
            }
            let offsetEnd = end;
            while (offsetEnd < string.length) {
                if (!/\s/.test(string[offsetEnd + 1]))
                    offsetEnd++;
                else {
                    let oe = offsetEnd;
                    while (oe < string.length && /\s/.test(string[oe + 1])) {
                        oe++;
                    }
                    if ([...string.substring(offsetEnd, oe + 1).matchAll(/\n/g)].length > 1) {
                        offsetEnd++;
                        break;
                    }
                    offsetEnd = oe;
                }
            }
            return [offsetStart, offsetEnd];
        }

        function findWhitespaceLine(editor) {
            console.log("findWhitespaceLine, ");
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            let string = editor.value;
            let offsetStart = start;
            while (offsetStart > 0) {
                if (string[offsetStart - 1] !== '\n')
                    offsetStart--;
                else {
                    while (offsetStart > 0) {
                        if (/\s/.test(string[offsetStart - 1]))
                            offsetStart--;
                        else break;
                    }
                    break;
                }
            }
            let offsetEnd = end;
            while (offsetEnd < string.length) {
                if (string[offsetEnd + 1] !== '\n')
                    offsetEnd++;
                else {
                    while (offsetEnd < string.length) {
                        if (/\s/.test(string[offsetEnd + 1]))
                            offsetEnd++;
                        else break;
                    }
                    break;
                }
            }
            return [offsetStart, offsetEnd];
        }

        function formatCurrent(editor) {
            console.log("formatCurrent, ");
            let start = editor.selectionStart;
            let end = editor.selectionEnd;
            const string = editor.value;
            while (end < string.length && (string.charAt(end) !== '\n' && string.charAt(end) !== '。')) {
                end++;
            }
            if (start !== 0) start++;
            if (end < string.length) end++;
            const value = string.substring(start, end);
            editor.focus();
            editor.setRangeText(value.replace(/，/g, '、'), start, end);
        }

        function formatHead(editor, count) {
            // console.log("formatHead, ");
            // let start = editor.selectionStart;
            // const string = editor.value;
            // while (start - 1 > -1 && string.charAt(start - 1) !== '\n') {
            //     start--;
            // }
            // editor.setRangeText('#'.repeat(count || 2) + " ", start, start);

            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const string = editor.value;


            let offsetStart = start;
            while (offsetStart > 0) {
                if (string[offsetStart - 1] !== '\n')
                    offsetStart--;
                else {
                    while (offsetStart > 0) {
                        if (/\s/.test(string[offsetStart - 1]))
                            offsetStart--;
                        else break;
                    }
                    break;
                }
            }
            let offsetEnd = end;
            while (offsetEnd < string.length) {
                if (string[offsetEnd + 1] !== '\n')
                    offsetEnd++;
                else {
                    while (offsetEnd < string.length) {
                        if (/\s/.test(string[offsetEnd + 1]))
                            offsetEnd++;
                        else break;
                    }
                    break;
                }
            }

            editor.setRangeText(`\n\n${'#'.repeat(count)} ${string.substring(offsetStart, offsetEnd).trim()}\n`, offsetStart,
                offsetEnd);
        }

        function indent(editor, increase) {
            console.log("indent, ");
            const string = editor.value;
            const p = findExtendPosition(editor);
            editor.focus();
            const selection = string.substring(p[0], p[1]);
            editor.setRangeText(selection.split('\n').map(i => {
                if (increase) {
                    return `  ${i}`;
                } else {
                    return i.replace(/^ {2}/, '');
                }
            }).join('\n'), p[0], p[1]);
        }

        function makeItem(d, click, label) {
            console.log("makeItem, ");
            const a = document.createElement('A');
            if (click) {
                a.addEventListener('click', click);
            }
            a.style.width = '24px';
            a.style.height = '24px';
            a.style.display = 'block';
            a.style.padding = '8px';
            a.style.borderRight = '1px solid rgb(238, 238, 238)';
            a.style.position = 'relative';
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 24 24');
            svg.style.width = '24px';
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', d || 'M5.016 3.984h13.969v3h-5.484v12h-3v-12h-5.484v-3z');
            svg.appendChild(path);
            a.appendChild(svg);
            if (label) {
                a.setAttribute('aria-label', label);
            }
            return a;
        }

        function pasteSelectionText(editor) {
            let start = editor.selectionStart;
            let end = editor.selectionEnd;
            // const string = editor.value;
            // while (end < string.length && string.charAt(end) !== '\n') {
            //     end++;
            // }
            // editor.focus();
            // editor.setSelectionRange(start, end);
            // var command = document.execCommand('paste');
            // console.log(command);
            // console.log(navigator.clipboard);
            // editor.focus();
            // if (navigator.permissions) {
            //     navigator.permissions.query({
            //         name: "clipboard-read"
            //     }).then(result => {
            //         if (result.state == "granted" || result.state == "prompt") {
            //             /* write to the clipboard now */
            //         }
            //         console.log(result);
            //     });
            // }

            // if (!document.execCommand("paste")) {
            navigator.clipboard.readText().then(res => {
                editor.setRangeText(
                    res, start, end);
            })
            // }
            //editor.setRangeText(localStorage.getItem('string'), start, end);
        }

        function processSelection(editor, process) {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            let string = editor.value.substring(start, end);
            if (process) {
                string = process(string);
            }
            editor.setRangeText(string, start, end);
        }
        async function translate(query) {
            // const response = await fetch(`/api/book/trans?q=${query}`);
            // if (!response.ok) {
            //     throw new Error();
            // }
            // return await response.text();
        }

        function writeText(message) {
            console.log("writeText, ");
            const textarea = document.createElement("textarea");
            textarea.style.position = 'fixed';
            textarea.style.right = '100%';
            document.body.appendChild(textarea);
            textarea.value = message;
            textarea.select();
            document.execCommand('copy');
            textarea.remove();
        }
        class CustomToolbar extends HTMLElement {
            static get observedAttributes() {
                return ['editor'];
            }
            // Fires when an instance of the element is created or updated
            constructor() {
                super();
                this.root = this.attachShadow({
                    mode: 'open'
                });
                const style = document.createElement('style');
                style.textContent = CustomToolbar.getStyle();
                this.root.appendChild(style);

            }

            // Fires when an element is moved to a new document
            adoptedCallback() {
                console.log("adoptedCallback, ");
            }

            // Fires when an attribute was added, removed, or updated
            attributeChangedCallback(attrName, oldVal, newVal) {
                console.log("attributeChangedCallback, ");

                this.editor = document.querySelector(newVal);
            }

            // Fires when an instance was inserted into the document
            connectedCallback() {
                console.log("connectedCallback, ");

                this.editor.addEventListener('keydown', event => {
                    if (event.keyCode === 116) { // F5
                        event.preventDefault();
                        trans(this.editor);
                        //this.translate(this.editor);
                    }
                });
                this.editor.addEventListener('keydown', event => {
                    if (event.keyCode === 117) {
                        event.preventDefault();
                        const p = this.findWhitespaceLine(this.editor);
                        this.editor.setRangeText('\n', p[0], p[1]);
                    }
                });
                this.editor.addEventListener('keydown', event => {
                    if (event.keyCode === 118) {
                        event.preventDefault();
                        const p = this.findWhitespaceLine(this.editor);
                        this.editor.setRangeText('', p[0], p[1] + 1);
                    }
                });
                appendTrans(this.root, this.editor);
                appendRemove1(this.root, this.editor);
                //appendRemove2(this.root, this.editor);;
                //appendSplit(this.root, this.editor);
                // appendCut(this.root, this.editor);

                appendBold(this.root, this.editor);
                //appendItalic(this.root, this.editor);
                appendHeader2(this.root, this.editor);
                appendTranslate(this.root, this.editor);
                appendList(this.root, this.editor);
                appendIncreaseIndent(this.root, this.editor);
                appendCopy(this.root, this.editor);
                appendPaste(this.root, this.editor);
                // appendDecreaseIndent(this.root, this.editor);
                //appendVerticalSplit(this.root, this.editor);
            }

            // Fires when an instance was removed from the document
            disconnectedCallback() {
                console.log("disconnectedCallback, ");
            }


            processSelection(editor, process) {
                console.log("processSelection, ");

                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                let string = editor.value.substring(start, end);
                if (process) {
                    string = process(string);
                }
                editor.setRangeText(string, start, end);
            }

            removeWhiteSpace(editor) {
                console.log("removeWhiteSpace, ");

                let start = editor.selectionStart;
                let end = editor.selectionEnd;
                const string = editor.value;
                if (string.charAt(start) === '\n' && start - 1 > -1) {
                    start--;
                }
                while (start > 0 && string.charAt(start) !== '\n') {
                    start--;
                }
                if (/\s/.test(string.charAt(start))) {
                    while (start > 0 && /\s/.test(string.charAt(start))) {
                        start--;
                    }
                    start++;
                }
                while (end < string.length && string.charAt(end) !== '\n') {
                    end++;
                }
                while (end < string.length && /\s/.test(string.charAt(end))) {
                    end++;
                }
                const value = string.substring(start, end);
                console.log(start, end, value);
                editor.setRangeText(
                    '', start, end);
            }

            splitLine(editor) {
                console.log("splitLine, ");

                let start = editor.selectionStart;
                let end = editor.selectionEnd;
                const string = editor.value;
                if (string.charAt(start) === '\n' && start - 1 > -1) {
                    start--;
                }
                while (start > 0 && string.charAt(start) !== '\n') {
                    start--;
                }
                while (end < string.length && string.charAt(end) !== '\n') {
                    end++;
                }
                const value = string.substring(start, end);
                console.log(start, end, value);
                editor.setRangeText(
                    value.split(/[\\.。]/g).map(i => i + ".").join('\n\n'), start, end);
                // const string = editor.value;
                // const p = this.findExtendPosition(editor);
                // editor.focus();
                // const selection = string.substring(p[0], p[1]);
                // editor.setRangeText(
                //     selection.replaceAll(/[\r\n]+/g, ' '), p[0], p[1]);
                // .split('.').join('.\n\n')
            }

            translate(editor) {
                console.log("translate, ");

                // let start = editor.selectionStart;
                // let end = editor.selectionEnd;
                // const string = editor.value;
                // if (string.charAt(start) === '\n' && start - 1 > -1) {
                //     start--;
                // }
                // while (start > 0 && string.charAt(start) !== '\n') {
                //     start--;
                // }
                // while (end < string.length && string.charAt(end) !== '\n') {
                //     end++;
                // }
                // if (start !== 0) start++;
                // if (end < string.length) end++;
                // editor.focus();
                // editor.setSelectionRange(start, end);
                // const value = string.substring(start, end);
                const string = editor.value;
                const p = this.findExtendPosition(editor);
                editor.focus();
                const value = string.substring(p[0], p[1]).replaceAll(/[\r\n]+/g, ' ');
                const to = new URL(window.location.href).searchParams.get('to');
                fetch('https://lucidu.cn/api/book/translate', {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                    },
                    body: new URLSearchParams({
                        'q': value.replaceAll(/[^a-zA-Z0-9;?,'"\. )(:\/+—-]/g, ''),
                        'to': to || 'zh'
                    })
                }).then(res => {
                    return res.text();
                }).then(obj => {
                    editor.setRangeText(
                        value +
                        '\n\n' +
                        obj.replaceAll(/您/g, '你'), p[0], p[1]);
                })
            }
            static getStyle() {
                return `
:host::-webkit-scrollbar {
    display: none;
}
:host{
    border: 1px solid #eee;
border-right: 0;
display: flex;
flex-direction: row;
overflow-x:auto;
flex-wrap: wrap;
}
@keyframes tooltip-appear {
    0% {
        opacity: 0
    }
    to {
        opacity: 1
    }
}
a:before {
    position: absolute;
    z-index: 1000001;
    display: none;
    width: 0;
    height: 0;
    color: #636e7b;
    pointer-events: none;
    content: "";
    border: 6px solid transparent;
    opacity: 0;
}
a::before {
    top: 50%;
    right: -7px;
    bottom: 50%;
    margin-right: -6px;
    border-bottom-color: #636e7b;
}
a:hover:before, a:hover:after {
    display: inline-block;
    text-decoration: none;
    animation-name: tooltip-appear;
    animation-duration: .1s;
    animation-fill-mode: forwards;
    animation-timing-function: ease-in;
    animation-delay: .4s;
}
a:after {
    position: absolute;
    z-index: 1000000;
    display: none;
    padding: .5em .75em;
    font: normal normal 11px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;
    -webkit-font-smoothing: subpixel-antialiased;
    color: #f0f6fc;
    text-align: center;
    text-decoration: none;
    text-shadow: none;
    text-transform: none;
    letter-spacing: normal;
    word-wrap: break-word;
    white-space: pre;
    pointer-events: none;
    content: attr(aria-label);
    background:  #636e7b;
    border-radius: 6px;
    opacity: 0;
}
a:after {
    bottom: 50%;
    left: 100%;
    margin-left: 6px;
    transform: translateY(50%);
}
`;
            }
        }
        customElements.define('custom-toolbar', CustomToolbar);
// <custom-toolbar></custom-toolbar>
// <script src="http://localhost:8080/components/toolbar.js">
    </script>
    <script>
        const textarea = document.querySelector('textarea');
        textarea.value = localStorage.getItem('storage');
        textarea.addEventListener('keydown', function (e) {
            if (e.keyCode === 9) { // tab was pressed
                // get caret position/selection
                const start = this.selectionStart;
                const end = this.selectionEnd;
                const target = e.target;
                const value = target.value;
                // set textarea value to: text before caret + tab + text after caret
                target.value = value.substring(0, start) +
                    "\t" +
                    value.substring(end);
                // put caret at right position again (add one for the tab)
                this.selectionStart = this.selectionEnd = start + 1;
                // prevent the focus lose
                e.preventDefault();
            }
        }, false);
        document.addEventListener("visibilitychange", function () {
            localStorage.setItem('storage', textarea.value);
        });
    </script>
</body>

</html>